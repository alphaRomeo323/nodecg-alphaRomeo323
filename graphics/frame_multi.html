<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>frame</title>
        <link rel="preconnect" href="https://fonts.gstatic.com" />
        <link
            href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500&display=swap"
            rel="stylesheet"
        />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link href="frame.css" rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="common.js"></script>
    </head>
    <body class="m-0 w-screen h-screen overflow-hidden text-[32px]">
        <div class="absolute greenback border-stone-400 rounded-br-lg drop-shadow-lg"></div>
        <div id="title-box"class="absolute border-stone-600 border-8 rounded-xl text-center overflow-hidden flex items-center textbox-bg title">
            <span id="title" class="font-jp"></span>
        </div>
        <div id="right-box-upper" class="absolute border-stone-600 border-8 rounded-xl textbox-bg right-box upper">
            <div id="vc" class="text-[24px] font-jp absolute overflow-hidden top-2 left-2">
            </div>
        </div>
        <div id="right-box-lower" class="absolute border-stone-600 border-8 rounded-xl textbox-bg right-box lower"></div>
        <div id="bottom-box" class="absolute border-stone-600 border-8 rounded-xl textbox-bg bottom-box">
            <div id="bottom-box-text"class="absolute top-1 left-1 right-1 bottom-1 text-[40px] leading-tight overflow-hidden flex items-center">  
                <span id="memo" class="font-jp"></span>
            </div>  
        </div>
        <div class="absolute bg-slate-200 bottom-0 border-stone-600 border-8 w-screen h-16 bottom-border whitespace-nowrap overflow-hidden">
            <div id="animation-text" class="absolute font-jp h-16 align-middle"></div>
        </div>
        <div class="absolute bg-white px-4 rounded-full align-middle overflow-hidden border-stone-600 border-4 bottom-0 right-2">
            <span class="material-icons">schedule</span>
            <span id="clock" class="font-jp"></span>
        </div>
        <div class="absolute logo top-8">
            <img id="logo">
        </div>
        <div id="current" class="absolute backdrop-blur-md bg-slate-200/50 top-8 right-0 current rounded-l-lg overflow-hidden hidden">
            <div class="font-jp ml-1">
                <section>
                    <span class="material-icons align-sub text-4xl mr-2">queue_music</span>
                    <span id="track-name"></span>
                </section>
                <section>
                    <span id="track-artist"></span>
                </section>
                <section>
                    <span id="track-album"></span>
                </section>
            </div>
        </div>    
        <div id="vc-template" class="align-middle hidden text-left">
            <img class="rounded-full inline shadow-2xl"
                src="https://cdn.discordapp.com/icons/442549986207596544/a_4d26de7c9984ef733532a153e499cebf.gif?size=4096"
                width="40" height="40" />
            <span class="inline">Test</span>
        </div>    
    </body>
    <script>
const scrollSpeed = 16;
        const defaultFontSize = 32;
        const BGMdelay = 10000;
        const infoRep = nodecg.Replicant("frame-info");
        const playBackRep = nodecg.Replicant("playback");
        var current;
        setInterval(() => {
            clock(document.getElementById("clock"));
        }, 1000);

        nodecg.Replicant("title").on("change", (newValue) => {
            const titleElm = document.getElementById("title-box");
            const titleText = document.getElementById("title");
            anime({
                targets: titleText,
                opacity: [{ value: 1, duration: 0 }, { value: 0 }],
                duration: 1000,
                easing: "linear",
                complete: function(anim) {
                    if ( newValue != undefined){
                        titleText.innerText = newValue
                        titleElm.style.fontSize = '56px';
                        for(
                            size = 56;
                            titleElm.getBoundingClientRect().height < titleElm.scrollHeight && size > 12;
                            size--
                        ) {
                            titleElm.style.fontSize = size + 'px';
                        }
                    }
                    anime({
                        targets: titleText,
                        opacity: [{ value: 0, duration: 0 }, { value: 1 }],
                        duration: 1000,
                        delay: 500,
                        easing: "linear",
                    });
                }
            });
        });
        nodecg.Replicant("memo").on("change", (newValue) => {
            const bottomBoxElm = document.getElementById("bottom-box-text");
            const bottomBoxText = document.getElementById("memo");
            anime({
                targets: bottomBoxText,
                opacity: [{ value: 1, duration: 0 }, { value: 0 }],
                duration: 1000,
                easing: "linear",
                complete: function(anim) {
                    if ( newValue != undefined){
                        bottomBoxText.innerText = newValue
                        bottomBoxElm.style.fontSize = '56px';
                        for(
                            size = 56;
                            bottomBoxElm.getBoundingClientRect().height < bottomBoxElm.scrollHeight && size > 12;
                            size--
                        ) {
                            bottomBoxElm.style.fontSize = size + 'px';
                        }
                    }
                    anime({
                        targets: bottomBoxText,
                        opacity: [{ value: 0, duration: 0 }, { value: 1 }],
                        duration: 1000,
                        easing: "linear",
                        delay: 500
                    });
                }
            });
        });
        nodecg.Replicant("logo").on("change", (newValue) => {
            if(newValue != undefined){
                document.getElementById("logo").src = newValue;
            }
        });

        function watchValue(obj, propName, func) {
            let value = obj[propName];
            Object.defineProperty(obj, propName, {
                get: () => value,
                set: newValue => {
                    value = newValue;
                    func(newValue);
                },
                configurable: true
            });
        }
        NodeCG.waitForReplicants(infoRep).then(() => {
            const current = {value : null};
            const animElm = document.getElementById("animation-text")

            function onChange(newValue){
                if (newValue >= infoRep.value.length){
                    current.value = 0;
                    return;
                }
                const newInfo = infoRep.value[newValue];
                let messageLength = 0;
                let tempHTML = ''
                if (newInfo.svg !== ''){
                    messageLength += 2;
                    tempHTML += `<img src="svg/${newInfo.svg}" class="h-8 float-left mt-3 mr-2">`
                }
                else if(newInfo.materialIcon !== '') {
                    messageLength += 1;
                    tempHTML += `<span class="material-icons align-sub text-4xl mr-2">${newInfo.materialIcon}</span>`
                }
                messageLength += newInfo.content.length
                tempHTML += newInfo.content;

                animElm.innerHTML = tempHTML;
                
                anime({
                    targets: animElm,
                    translateX: [{ value: window.innerWidth, duration: 0 }, { value: -1 * defaultFontSize * messageLength }],
                    easing: "linear",
                    duration: scrollSpeed * ( window.innerWidth + defaultFontSize * messageLength),
                    complete: function(anim){
                        current.value++;
                    }
                })
            }
            Object.getOwnPropertyNames(current).forEach(propName => watchValue(current, propName, onChange));
            if(infoRep !== undefined)
                current.value = 0;
            
        })
        NodeCG.waitForReplicants(playBackRep).then(() =>{
            const currentBGMElm = document.getElementById("current");
            const trackNameElm = document.getElementById("track-name");
            const trackArtistElm = document.getElementById("track-artist");
            const trackAlbumElm = document.getElementById("track-album");
            playBackRep.on("change",(newValue) =>{
                trackArtistElm.innerText = "";
                trackAlbumElm.innerText = "";
                if (newValue.playing === false){
                    trackNameElm.innerText = "Stopped"
                    return;
                }
                trackNameElm.innerText = newValue.track;
                if (newValue.artist !== "")
                    trackArtistElm.innerText = `by ${newValue.artist}`;
                if (newValue.album !== "")
                    trackAlbumElm.innerText = `from ${newValue.album}`;
                if (tl === undefined)
                    currentBGMElm.classList.remove("hidden");
                else tl.remove(currentBGMElm);
                var tl = anime.timeline({
                easing: 'easeOutExpo',
                duration: 750,
                });
                tl.add({
                    targets:currentBGMElm,
                    translateX: [{ value: 380, duration: 0 }, { value: 0 }],
                    duration: 1000,
                });
                tl.add({
                    targets:currentBGMElm,
                    translateX: 380,
                    duration: 1000,
                    delay: BGMdelay,
                });
            });
        })
        nodecg.Replicant("vc", 'nodecg-discord-utils').on("change", (newValue) => {
            const vcElem = document.getElementById("vc");
            let child = vcElem.lastElementChild;
            while (child) {
                vcElem.removeChild(child);
                child = vcElem.lastElementChild;
            }
            newValue.forEach((value) => {
                let tmpElem = document.getElementById("vc-template").cloneNode(true);
                tmpElem.classList.remove("hidden")
                tmpElem.id = "";
                tmpElem.firstElementChild.src = value.avatar;
                tmpElem.lastElementChild.innerText = value.name;
                vcElem.appendChild(tmpElem);
            })
        });
    </script>
</html>
